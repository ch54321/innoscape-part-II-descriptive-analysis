```{r, echo=FALSE}

# (2) Creating coordinates for each unique technology that is cited in a c
# credit: https://stackoverflow.com/users/1465387/sebastian-c on
# https://stackoverflow.com/questions/40279052/coordinates-of-equally-distanced-n-points-on-a-circle-in-r
  eq_spacing <- function(n, r = 1){
    polypoints <- seq(0, 2*pi, length.out=n+1)
    polypoints <- polypoints[-length(polypoints)]
    circx <- r * sin(polypoints)
    circy <- r * cos(polypoints)
    data.frame(x=circx, y=circy)
  }
  
  coord <- unique(citflow_ctry$tech_field_cited)
  coord <-data.frame(coord)
  
  numbers <- eq_spacing(nrow(coord))
  numbers <-data.frame(numbers)
  
  coord_f<-cbind(coord, numbers)
  colnames(coord_f) <- c("tech_field_cited", "x", "y")
  citflow_ctry<-merge(citflow_ctry,coord_f)
    
fluidPage(
  fluidRow(
    column(4,  
# (3) Input panels for continent (group) and year
  pickerInput(inputId = "group",
              label = "Origin of citation", 
              choices=c("All", "Americas", "Asia", "Europe", "Domestic"),
              selected = c("All"),
              options = list(`actions-box` = TRUE),
              multiple = TRUE)
), column(4,
# (3b) Input panels for first citation country
    pickerInput(inputId = "cit_ctry",
              label = "Citations by (first country)", 
              choices= unique(citflow_ctry$ctry_cited),
              selected = c("Switzerland"),
              options = list(`actions-box` = TRUE),
              multiple = FALSE)
), column(4,    
# (3b) Input panels for second citation country
    pickerInput(inputId = "cit_ctry_2",
              label = "Citations by (second country, for comparison)", 
              choices= unique(citflow_ctry$ctry_cited),
              selected = c("United States"),
              options = list(`actions-box` = TRUE),
              multiple = FALSE)
)))

sliderInput(inputId = "p_year_citing", label =  "Year of citation", 
              min=1990, max=2015, value=1990, sep="")

fluidPage(
  fluidRow(
    column(6,
# (4) make the first plot
renderVisNetwork({
  
# (a) subset the data according to the input and store it for determining nodes and edges:

  nodes<- citflow_ctry %>% filter(group %in% input$group, 
                                   ctry_cited %in% input$cit_ctry,
                                   p_year_citing %in% input$p_year_citing)
  edges <- nodes
    
# (b) Creating NODES from the reactive (filtered) data
  nodes <- dplyr::select(nodes, tech_field_cited, tech_name, group, x, y, share_inv_cited)
  colnames(nodes) <- c("id", "label", "group", "x", "y", "value_nodes")
  nodes$label<- ifelse(nodes$label == "Pharmaceuticals", paste0(input$cit_ctry, " Pharmaceuticals"), nodes$label)
      
  nodes %>% group_by(id, label, x, y, value_nodes) %>%
    summarize(group = paste(sort(unique(group)),collapse=", ")) %>% 
    ungroup()  -> nodes
      
  mutate(nodes, x = case_when(
        label == paste0(input$cit_ctry, " Pharmaceuticals") ~ 0, 
        TRUE   ~ x )) -> nodes


  mutate(nodes, y = case_when(
        label == paste0(input$cit_ctry, " Pharmaceuticals") ~ 0, 
        TRUE   ~ y )) -> nodes
      
      
# (c) Creating EDGES from the reactive (filtered) data    
  edges <- subset(edges, select = c("tech_field_citing", "tech_field_cited" ,"share_inv_cited", "group"))
  colnames(edges) <- c("from", "to", "value", "group")
  edges <- filter(edges, value != 0)
  edges$title <- paste0(round(edges$value, 2))
   
# (d) keep only observations above a min threshold
  edges <- filter(edges, value > 0.02)
  nodes <- filter(nodes, id %in% edges$to | id == 16)
  
# (e) Define different colors for different regions
  nodes <- mutate(nodes, value = ifelse(x == 0 & y == 0, 1, value_nodes), color = case_when(group == "All" ~ "red",
                                                                                            group == "Europe" ~ "blue",
                                                                                            group == "Americas" ~ "green", 
                                                                                            group == "Asia" ~ "lightblue",
                                                                                            group == "Domestic" ~ "green"),
                  group = ifelse(group %in% c("All", "Europe", "Asia", "Americas", "Domestic"), group, NA))
  
# (f) create data frame for legend 
 nodes_temp <- filter(nodes, is.na(group) != T)
 ledges <- data.frame(color = unique(nodes_temp$color), 
 label = unique(nodes_temp$group), shape = rep("dot", length(unique(nodes_temp$group)))) 
 
# (g) Creating Network Plot
  visNetwork(nodes, edges, height = "100%",  width = "100%", main = input$cit_ctry) %>%
      visIgraphLayout(layout = "layout_nicely") %>%
      visEvents(type = "once", startStabilizing = "function() {
               this.moveTo({scale:0.5})}") %>%
      visPhysics(stabilization = FALSE) %>%
      visNodes(
        fixed = TRUE,
        shape = "dot",
        color = "red",
        shadow = list(enabled = F, size = 20)
        ) %>%
    visEdges(
        value="value",
        scaling = list(min = min(unique(edges$value), rm.na = T)*15, max = max(unique(edges$value), rm.na = T)*15),
        arrows = "to",
        color="lightgrey",
        selfReferenceSize = F,
        shadow = FALSE,
        smooth = FALSE) %>%
    visInteraction(dragNodes = T, dragView = T, zoomView = T)%>%
    visOptions(highlightNearest = list(enabled = F, degree = 1, hover = T))%>%
     visLegend(position = "right", useGroups = F, addNodes = ledges)
  })    
), column(6,
# make the 2nd plot
renderVisNetwork({
  
# (a) subset the data according to the input and store it for determining nodes and edges:

  nodes_2 <- citflow_ctry %>% filter(group %in% input$group, 
                                   ctry_cited %in% input$cit_ctry_2,
                                   p_year_citing %in% input$p_year_citing)
  edges_2 <- nodes_2
    
# (b) Creating NODES from the reactive (filtered) data
  nodes_2 <- dplyr::select(nodes_2, tech_field_cited, tech_name, group, x, y, share_inv_cited)
  colnames(nodes_2) <- c("id", "label", "group", "x", "y", "value_nodes")
  nodes_2$label<- ifelse(nodes_2$label == "Pharmaceuticals", paste0(input$cit_ctry_2, " Pharmaceuticals"), nodes_2$label)
      
  nodes_2 %>% group_by(id, label, x, y, value_nodes) %>%
    summarize(group = paste(sort(unique(group)),collapse=", ")) %>% 
    ungroup()  -> nodes_2
      
  mutate(nodes_2, x = case_when(
        label == paste0(input$cit_ctry_2, " Pharmaceuticals") ~ 0, 
        TRUE   ~ x )) -> nodes_2

  mutate(nodes_2, y = case_when(
        label == paste0(input$cit_ctry_2, " Pharmaceuticals") ~ 0, 
        TRUE   ~ y )) -> nodes_2
      
      
# (c) Creating EDGES from the reactive (filtered) data    
  edges_2 <- subset(edges_2, select = c("tech_field_citing", "tech_field_cited" ,"share_inv_cited", "group"))
  colnames(edges_2) <- c("from", "to", "value", "group")
  edges_2 <- filter(edges_2, value != 0)
  edges_2$title <- paste0(round(edges_2$value, 2))
   
# (d) keep only observations above a min threshold
  edges_2 <- filter(edges_2, value > 0.02)
  nodes_2 <- filter(nodes_2, id %in% edges_2$to | id == 16)
  
# (e) Define different colors for different regions
  nodes_2 <- mutate(nodes_2, value = ifelse(x == 0 & y == 0, 1, value_nodes), color = case_when(group == "All" ~ "red",
                                                                                            group == "Europe" ~ "blue",
                                                                                            group == "Americas" ~ "green", 
                                                                                            group == "Asia" ~ "lightblue",
                                                                                            group == "Domestic" ~ "green"),
                  group = ifelse(group %in% c("All", "Europe", "Asia", "Americas", "Domestic"), group, NA))
  
# (f) create data frame for legend 
 # nodes_temp <- filter(nodes, is.na(group) != T)
 # ledges <- data.frame(color = unique(nodes_temp$color), 
 # label = unique(nodes_temp$group), shape = rep("dot", length(unique(nodes_temp$group)))) 
 
# (g) Creating Network Plot
  visNetwork(nodes_2, edges_2, height = "100%",  width = "100%", main = input$cit_ctry_2) %>%
      visIgraphLayout(layout = "layout_nicely") %>%
      visEvents(type = "once", startStabilizing = "function() {
               this.moveTo({scale:0.5})}") %>%
      visPhysics(stabilization = FALSE) %>%
      visNodes(
        fixed = TRUE,
        shape = "dot",
        color = "red",
        shadow = list(enabled = F, size = 20)
        ) %>%
    visEdges(
        value="value",
        scaling = list(min = min(unique(edges_2$value), rm.na = T)*15, max = max(unique(edges_2$value), rm.na = T)*15),
        arrows = "to",
        color="lightgrey",
        selfReferenceSize = F,
        shadow = FALSE,
        smooth = FALSE) %>%
    visInteraction(dragNodes = T, dragView = T, zoomView = T)%>%
    visOptions(highlightNearest = list(enabled = F, degree = 1, hover = T)) 
  # %>%
     # visLegend(position = "right", useGroups = F, addNodes = ledges)
  }) 
)))
```