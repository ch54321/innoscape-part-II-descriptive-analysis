```{r, echo = F}

select_regio <- distinct(dat_ii, Region, `Rank based on total patents`)  %>% na.omit()

output$regio <- DT::renderDT(select_regio, server = F, extensions = 'Scroller',  
                  filter = "top", # location of column filters
                  rownames= FALSE,
                  class = "display nowrap compact", 
                  selection = list(mode = 'multiple', selected = which(select_regio$Region %in% c("CH - Northwestern Switzerland "))),
                  options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
         			columnDefs = list(list(className = 'dt-center', targets = 1))))


selectedRow_regio <- eventReactive(input$regio_rows_selected,{
   select_regio[input$regio_rows_selected, "Region"]
  })

DT::dataTableOutput('regio')

## Add clearing of rows
proxy <- dataTableProxy('regio')
actionButton('clear_reg', 'Clear Selection')
observeEvent(input$clear_reg, {
    proxy %>% selectRows(NULL)
  })

## Add button to choose between absolut and relative value
actionButton('abs_rel_regio', "Absolute/relative value")
abs_rel_regio <- eventReactive(input$abs_rel_regio,{
ifelse(input$abs_rel_regio %in% c(0, seq(2, 1000, 2)), "abs", "rel_1990")}, ignoreNULL = FALSE)

## Add button to choose between count each region as one (ie, 3 inventors in three regions, each region counts as one for this patent) or count the relative share of each region (ie, 3 inventors in three regions, each region counts as 1/3 for this patent) 
actionButton('geo_one_inv_region', "Region count as share or share/one")
geo_one_inv_region <- eventReactive(input$geo_one_inv_region,{
ifelse(input$geo_one_inv_region %in% c(0, seq(2, 1000, 2)), "no", "no_yes")}, ignoreNULL = FALSE)

## Add button to choose between absolute value or share relative to overall patents for a given year
actionButton("geo_share_regio", "Absolute value / relative to all patents")
geo_share_regio <- eventReactive(input$geo_share_regio, {ifelse(input$geo_share_regio %in% c(0, seq(2, 1000, 2)), "abs", "rel")}, ignoreNULL = FALSE)


## Create plot
renderPlotly({
  plot02_data_regio <- filter(dat_ii, Region %in% selectedRow_regio() & ipc_3 == "all" & abs_rel %in% abs_rel_regio() & geo_one_inv %in% geo_one_inv_region())
 if(geo_share_regio() == "abs"){
          # make the plot
                 ggplotly(
                 ggplot(data = plot02_data_regio, aes(x = p_year, y= share_inv, color = Region, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 scale_x_continuous(breaks = seq(min(plot02_data_regio$p_year), max(plot02_data_regio$p_year), by = 5)) +
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = T) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=F, 
                                rangeslider = list(type = "date", visible=T))) %>%
                 layout(yaxis = list(fixedrange=F)) 
 } else {
                    ggplotly(
                 ggplot(data = plot02_data_regio, aes(x = p_year, y= share_geo, color = Region, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 scale_x_continuous(breaks = seq(min(plot02_data_regio$p_year), max(plot02_data_regio$p_year), by = 5)) +
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = T) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=F, 
                                rangeslider = list(type = "date", visible=T))) %>%
                 layout(yaxis = list(fixedrange=F)) 
 }
         })

        
```
