---
output: 
   html_document:
      css: style.css
runtime: shiny
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(ggplot2)
library(xtable)
library(DT)
library(viridis)
library(RColorBrewer)
library(knitr)
library(png)
library(cowplot)
library(plotly)
library(viridis)
library(autoimage)
library(shinyWidgets)
library(plyr)
library(dplyr)
library(data.table)
```

<!-- <head> -->
<!-- <!-- Global site tag (gtag.js) - Google Analytics --> -->
<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-71167447-1"></script> -->
<!-- <script> -->
<!--   window.dataLayer = window.dataLayer || []; -->
<!--   function gtag(){dataLayer.push(arguments);} -->
<!--   gtag('js', new Date()); -->
<!--   gtag('config', 'UA-71167447-1'); -->
<!-- </script> -->
<!-- </head> -->

```{r, echo = F}
# Load data
dat_ii <- readRDS("num_pat_16.rds") %>% data.frame() 
dat_ii <- filter(dat_ii, n_ipc > 1000)
dat_ii_world <- readRDS("world_class_16.rds") %>% data.frame()

dat_ii <- mutate(dat_ii, geo_level = case_when(is.na(conti) != T ~ "conti", is.na(ctry_code) != T ~ " ctry", is.na(Up_reg_label) != T ~ "regio"))
dat_ii <- setDT(dat_ii)[, ges_pat_geo := sum(share_inv[abs_rel == "abs" & ipc_3 == "all"]), .(geo)]
dat_ii <- setDT(dat_ii)[, `Rank based on total patents` := dense_rank(desc(ges_pat_geo)), .(geo_level)]

## Calculate yearly share of an geographic region 
dat_ii <- setDT(dat_ii)[, ges_pat_year := sum(share_inv[abs_rel == "abs" & ipc_3 == "all"]), .(p_year)]
dat_ii <- setDT(dat_ii)[, ges_pat_geo_year := sum(share_inv[abs_rel == "abs" & ipc_3 == "all"]), .(geo, p_year)]
dat_ii <- mutate(dat_ii, share_geo = ges_pat_geo_year / ges_pat_year)

dat_ii <- dplyr::rename(dat_ii, Continent = conti, Region = Up_reg_label, Country = ctry_name)
dat_ii <- as.data.frame(dat_ii)
```


<br>

[![Foo](cieb_logo.jpg){ width=18% }](http://cieb.unibas.ch/)&nbsp;&nbsp;

## <font color="grey"> **Innoscape: Descriptive Analysis of Pharma Innovations** </font>

*June 2020* <a href="https://cieb.unibas.ch/de/team/dragan-filimonovic/" target = "_blank">Dragan Filimonovic</a>, <a href="https://cieb.unibas.ch/de/team/matthias-niggli/" target = "_blank">Matthias Niggli</a> and <a href="https://cieb.unibas.ch/de/team/dr-christian-rutzer/" target = "_blank">Christian Rutzer</a>


<br>

<br>

#### <font color='grey'> **Development of the Pharma Sector in Switzerland ** </font>


<br>
<br>

## {.tabset}


### Continents

```{r, echo = F}

select_conti <- distinct(dat_ii, Continent, `Rank based on total patents`)  %>% na.omit()

output$conti =  DT::renderDT(select_conti, extensions = 'Scroller', server = F,
                  class = "display nowrap compact", # style
                  filter = "top", # location of column filters
                  rownames= FALSE,
                  fillContainer = T,
                  selection = list(mode = 'multiple', selected = which(select_conti$Continent %in% c("Europe"))),
                  options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
         			columnDefs = list(list(className = 'dt-center', targets = 1))))

DT::dataTableOutput('conti')

## Add clearing of rows
proxy_conti <- dataTableProxy('conti')
actionButton('clear_conti', 'Clear Selection')
observeEvent(input$clear_conti, {
    proxy_conti %>% selectRows(NULL)
  })

selectedRow_conti <- eventReactive(input$conti_rows_selected,{
   select_conti[input$conti_rows_selected, "Continent"]
  })

## Add button to choose between absolut and relative value
actionButton('abs_rel_conti', "Absolute/relative value")
abs_rel_conti <- eventReactive(input$abs_rel_conti,{
ifelse(input$abs_rel_conti %in% c(0, seq(2, 1000, 2)), "abs", "rel_1990")}, ignoreNULL = FALSE)

## Add button to choose between count each region as one (ie, 3 inventors in three regions, each region counts as one for this patent) or count the relative share of each region (ie, 3 inventors in three regions, each region counts as 1/3 for this patent) 
actionButton('geo_one_inv_conti', "Region count as share or share/one")
geo_one_inv_conti <- eventReactive(input$geo_one_inv_conti,{
ifelse(input$geo_one_inv_conti %in% c(0, seq(2, 1000, 2)), "no", "no_yes")}, ignoreNULL = FALSE)


# renderText(selectedRow_conti())

renderPlotly({
  plot02_data_conti <- filter(dat_ii, Continent %in% selectedRow_conti() & ipc_3 == "all" & abs_rel %in% abs_rel_conti() & geo_one_inv %in% geo_one_inv_conti())

          # make the plot
                 ggplotly(
                 ggplot(data =   plot02_data_conti, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 scale_x_continuous(breaks = seq(min(plot02_data_conti$p_year), max(plot02_data_conti$p_year), by = 5)) +
                 # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()), 
                 dynamicTicks = FALSE) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=F, 
                                rangeslider = list(type = "date", visible=T, thickness=0.1))) %>%
                 layout(yaxis = list(fixedrange=F)) 
         })

        
```

### Countries

```{r, echo = F}

select_country <- distinct(dat_ii, Country, `Rank based on total patents`)  %>% na.omit()

output$country <- DT::renderDT(select_country, server = F, extensions = 'Scroller',  
                  filter = "top", # location of column filters
                  rownames= FALSE,
                  class = "display nowrap compact", 
                  selection = list(mode = 'multiple', selected = which(select_country$Country %in% c("Germany", "Switzerland", "United States"))),
                  options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
         			columnDefs = list(list(className = 'dt-center', targets = 1))))


selectedRow_ctry <- eventReactive(input$country_rows_selected,{
   select_country[input$country_rows_selected, "Country"]
  })

DT::dataTableOutput('country')

# renderText(selectedRow_ctry())

## Add clearing of rows
proxy_ctry <- dataTableProxy('country')
actionButton('clear_ctry', 'Clear Selection')
observeEvent(input$clear_ctry, {
    proxy_ctry %>% selectRows(NULL)
  })



## Add button to choose between absolut and relative value
actionButton('abs_rel_country', "Absolute/relative value")
abs_rel_country <- eventReactive(input$abs_rel_country,{
ifelse(input$abs_rel_country %in% c(0, seq(2, 1000, 2)), "abs", "rel_1990")}, ignoreNULL = FALSE)

## Add button to choose between count each region as one (ie, 3 inventors in three regions, each region counts as one for this patent) or count the relative share of each region (ie, 3 inventors in three regions, each region counts as 1/3 for this patent) 
actionButton('geo_one_inv_country', "Region count as share or share/one")
geo_one_inv_country <- eventReactive(input$geo_one_inv_country,{
ifelse(input$geo_one_inv_country %in% c(0, seq(2, 1000, 2)), "no", "no_yes")}, ignoreNULL = FALSE)

## Create plot
renderPlotly({
  plot02_data_country <- filter(dat_ii, Country %in% selectedRow_ctry() & ipc_3 == "all" & abs_rel %in% abs_rel_country() & geo_one_inv %in% geo_one_inv_country())

          # make the plot
                 ggplotly(
                 ggplot(data = plot02_data_country, aes(x = p_year, y= share_inv, color = Country, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 scale_x_continuous(breaks = seq(min(plot02_data_country$p_year), max(plot02_data_country$p_year), by = 5)) +
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ), dynamicTicks = T) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=F, 
                                rangeslider = list(type = "date", visible=T))) %>%
                 layout(yaxis = list(fixedrange=F)) 
         })

        
```


HERE short description of the findings at the country level


### Regions
```{r, echo = F}

select_regio <- distinct(dat_ii, Region, `Rank based on total patents`)  %>% na.omit()

output$regio <- DT::renderDT(select_regio, server = F, extensions = 'Scroller',  
                  filter = "top", # location of column filters
                  rownames= FALSE,
                  class = "display nowrap compact", 
                  selection = list(mode = 'multiple', selected = which(select_regio$Region %in% c("CH - Northwestern Switzerland "))),
                  options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
         			columnDefs = list(list(className = 'dt-center', targets = 1))))


selectedRow_regio <- eventReactive(input$regio_rows_selected,{
   select_regio[input$regio_rows_selected, "Region"]
  })

DT::dataTableOutput('regio')

## Add clearing of rows
proxy <- dataTableProxy('regio')
actionButton('clear_reg', 'Clear Selection')
observeEvent(input$clear_reg, {
    proxy %>% selectRows(NULL)
  })

## Add button to choose between absolut and relative value
actionButton('abs_rel_regio', "Absolute/relative value")
abs_rel_regio <- eventReactive(input$abs_rel_regio,{
ifelse(input$abs_rel_regio %in% c(0, seq(2, 1000, 2)), "abs", "rel_1990")}, ignoreNULL = FALSE)

## Add button to choose between count each region as one (ie, 3 inventors in three regions, each region counts as one for this patent) or count the relative share of each region (ie, 3 inventors in three regions, each region counts as 1/3 for this patent) 
actionButton('geo_one_inv_region', "Region count as share or share/one")
geo_one_inv_region <- eventReactive(input$geo_one_inv_region,{
ifelse(input$geo_one_inv_region %in% c(0, seq(2, 1000, 2)), "no", "no_yes")}, ignoreNULL = FALSE)

## Create plot
renderPlotly({
  plot02_data_regio <- filter(dat_ii, Region %in% selectedRow_regio() & ipc_3 == "all" & abs_rel %in% abs_rel_regio() & geo_one_inv %in% geo_one_inv_region())

          # make the plot
                 ggplotly(
                 ggplot(data = plot02_data_regio, aes(x = p_year, y= share_inv, color = Region, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 scale_x_continuous(breaks = seq(min(plot02_data_regio$p_year), max(plot02_data_regio$p_year), by = 5)) +
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = T) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=F, 
                                rangeslider = list(type = "date", visible=T))) %>%
                 layout(yaxis = list(fixedrange=F)) 
              
         })

        
```



HERE short description of the findings at the regional level

## {.unlisted .unnumbered}


