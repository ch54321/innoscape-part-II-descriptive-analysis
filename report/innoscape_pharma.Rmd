---
output: 
   html_document:
      css: style.css
runtime: shiny
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(ggplot2)
library(xtable)
library(DT)
library(viridis)
library(RColorBrewer)
library(knitr)
library(png)
library(cowplot)
library(plotly)
library(viridis)
library(autoimage)
library(shinyWidgets)
library(plyr)
library(dplyr)
library(data.table)
library(countrycode)
library("countrycode")
library("visNetwork")
source_rmd <- function(rmd_file){
  knitr::knit(rmd_file, output = tempfile())
}
```

<!-- # ```{r, context="data", include=FALSE} -->
<!-- # # Load data  -->
<!-- # dat_ii <- readRDS("num_pat_16.rds") %>% data.frame()  -->
<!-- # dat_ii <- filter(dat_ii, p_year < 2016) -->
<!-- # dat_ii <- setDT(dat_ii)[, ges_pat_geo := sum(share_inv[indicator == "abs"]), .(geo)] -->
<!-- # dat_ii <- setDT(dat_ii)[, `Rank based on total patents` := dense_rank(desc(ges_pat_geo)), .(geo_level)] -->
<!-- # dat_ii <- as.data.frame(dat_ii)   -->
<!-- #  -->
<!-- # tradedata <- readRDS("oecd_trade_ch_final.rds") -->
<!-- # labprod <- readRDS("lab_prod_final_ch.rds") -->
<!-- # gva <- readRDS("gva_data_ch.rds") -->
<!-- # ilo <- readRDS("iloemp_2020_final.rds") -->
<!-- # ilo <- subset(ilo,ind.code=="21") -->
<!-- # ``` -->


```{r, context="data", include=FALSE}
options(scipen=999)
# Load data 
dat_ii <- readRDS("num_pat_16.rds") %>% data.frame() 
dat_ii <- filter(dat_ii, p_year < 2016)
dat_ii <- setDT(dat_ii)[, ges_pat_geo := sum(share_inv[indicator == "abs"]), .(geo)]
dat_ii <- setDT(dat_ii)[, `Rank based on total patents` := dense_rank(desc(ges_pat_geo)), .(geo_level)]
dat_ii <- as.data.frame(dat_ii)  

# Load trade data
tradedata <- readRDS("oecd_trade_ch_final.rds")
tradedata_temp <- filter(tradedata, year == 2018 & variable == "val_export")
tradedata_temp <- distinct(tradedata_temp, par.code, .keep_all = T)
tradedata_temp <- setDT(tradedata_temp)[order(-value), .SD[1:60, ]]
tradedata <- filter(tradedata, par.code %in% unique(tradedata_temp$par.code))


tradedata <- mutate(tradedata, Country = paste0(countrycode(par.code, "iso3c", "country.name.en"), "\nYear: ", year, "\nValue: ", ifelse(variable %in% "val_export", paste0(round(value/1000, 0), " million USD"), paste0(round(value*100, 0), "%"))))

# filter the data to leave only Switzerland:
volumes <-transform(tradedata, year = as.numeric(year)) %>% # Transform to numeric values
            mutate_at(c("lat_par", "long_par", "lat_rep", "long_rep"), as.numeric)

# Create the world map:
map_world <- map_data(map = "world") %>%
               filter(region != "Antarctica")

map_world <- map_world[seq(1, nrow(map_world), 18), ]

# Load data on GVA
gva <- readRDS("gva_data_ch.rds")

# Load data on employment
ilo <- readRDS("iloemp_2020_final.rds")
ilo <- subset(ilo,ind.code=="21")

# Rename countries from ISO to complete name
ilo <- mutate(ilo, country = countrycode(country, "iso3c", "country.name.en"))

# Keep only countries having at least 6 years of data
ilo <- setDT(ilo)[, num := .N, .(ind.code, country, variable)]
ilo <- filter(ilo, num >= 6) %>% dplyr::select(-num)

# Prepare the data
ilo <- mutate(ilo, variable = case_when(variable == "share.emp" ~ "Share of employed", 
                                           variable == "num.emp" ~ "Number of employed in thousands")) %>%
          mutate(Country = paste0(" ", country, "\nYear: ", year, "\nIndicator: ", variable, "\nValue: ", ifelse(variable == "Share of employed", round(value, 4), round(value, 2))))


# Load data on labor prod.
labprod <- readRDS("lab_prod_final_ch.rds")

# Prepare the data
labprod <- mutate(labprod, variable = case_when(variable == "ilo_prod" ~ "Only domestic workers", 
                                                variable == "bfs_prod" ~ "Total jobs in firms",
                                                T ~ "Domestic and cross-border workers")) %>%
          mutate(Industry = paste0(" ", ind.name, "\nYear: ", year, "\nIndicator: ", variable, "\nValue: ", round(value/1000000, 2), " in millions CHF"))



numpat_data <- readRDS("num_pat_16.rds")
# Load backward citation data created in section_II/prep_report.R
citflow_ctry <- readRDS("/scicore/home/weder/rutzer/innoscape/part II descriptive analysis/report/citflow_ctry.rds")
```	

<!-- <head> -->
<!-- <!-- Global site tag (gtag.js) - Google Analytics --> -->
<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-71167447-1"></script> -->
<!-- <script> -->
<!--   window.dataLayer = window.dataLayer || []; -->
<!--   function gtag(){dataLayer.push(arguments);} -->
<!--   gtag('js', new Date()); -->
<!--   gtag('config', 'UA-71167447-1'); -->
<!-- </script> -->
<!-- </head> -->


<br>

[![Foo](cieb_logo.jpg){ width=18% }](http://cieb.unibas.ch/)&nbsp;&nbsp;

## <font color="grey"> **Innoscape: Descriptive Analysis of Pharma Innovations** </font>

*June 2020* <a href="https://cieb.unibas.ch/de/team/dragan-filimonovic/" target = "_blank">Dragan Filimonovic</a>, <a href="https://cieb.unibas.ch/de/team/matthias-niggli/" target = "_blank">Matthias Niggli</a> and <a href="https://cieb.unibas.ch/de/team/dr-christian-rutzer/" target = "_blank">Christian Rutzer</a>


<br>
<br>

#### <font color='grey'> **Development of the Pharma Sector in Switzerland ** </font>


<br>
<br>



### Value added
```{r, echo = F, child = file.path(knitr::opts_knit$get("output.dir"), "gva_output.Rmd")}
```

### Employment
```{r, echo = F, child = file.path(knitr::opts_knit$get("output.dir"), "emp_output.Rmd")}
```

### Labor productivity
```{r, echo = F, child = file.path(knitr::opts_knit$get("output.dir"), "labprod_output.Rmd")}
```

### Exports
```{r, echo = F, child = file.path(knitr::opts_knit$get("output.dir"), "export_output.Rmd")}
```

### Patent count and shares
```{r, echo = F, child = file.path(knitr::opts_knit$get("output.dir"), "numpat_output.Rmd")}
```

### Citations
```{r, echo = F, child = file.path(knitr::opts_knit$get("output.dir"), "citnetwork_output.Rmd")}
```

## {.tabset}

### Continents

```{r, echo = F, child = file.path(knitr::opts_knit$get("output.dir"), "conti_func.RMD")}
```

HERE short description of the findings at the continent level


### Countries

```{r, echo = F, child  = file.path(knitr::opts_knit$get("output.dir"), "ctry_func.Rmd")}
```




HERE short description of the findings at the country level


### Regions

```{r, echo = F, child  = file.path(knitr::opts_knit$get("output.dir"),'regio_func.Rmd')}
```




HERE short description of the findings at the regional level

## {.unlisted .unnumbered}