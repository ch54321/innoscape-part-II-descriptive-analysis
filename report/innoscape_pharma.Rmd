---
output: 
   html_document:
      css: style.css
runtime: shiny
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(ggplot2)
library(xtable)
library(DT)
library(viridis)
library(RColorBrewer)
library(knitr)
library(png)
library(cowplot)
library(plotly)
library(viridis)
library(autoimage)
library(shinyWidgets)
library(plyr)
library(dplyr)
library(data.table)
```

<!-- <head> -->
<!-- <!-- Global site tag (gtag.js) - Google Analytics --> -->
<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-71167447-1"></script> -->
<!-- <script> -->
<!--   window.dataLayer = window.dataLayer || []; -->
<!--   function gtag(){dataLayer.push(arguments);} -->
<!--   gtag('js', new Date()); -->
<!--   gtag('config', 'UA-71167447-1'); -->
<!-- </script> -->
<!-- </head> -->

```{r, echo = F}
# Load data
dat_ii <- readRDS("num_pat_16.rds") %>% data.frame() 
dat_ii <- filter(dat_ii, n_ipc > 1000)
dat_ii_world <- readRDS("world_class_16.rds") %>% data.frame()

```


<br>

[![Foo](cieb_logo.jpg){ width=18% }](http://cieb.unibas.ch/)&nbsp;&nbsp;

## <font color="grey"> **Innoscape: Descriptive Analysis of Pharma Innovations** </font>

*June 2020* <a href="https://cieb.unibas.ch/de/team/dragan-filimonovic/" target = "_blank">Dragan Filimonovic</a>, <a href="https://cieb.unibas.ch/de/team/matthias-niggli/" target = "_blank">Matthias Niggli</a> and <a href="https://cieb.unibas.ch/de/team/dr-christian-rutzer/" target = "_blank">Christian Rutzer</a>


<br>

<br>

#### <font color='grey'> **Development of the Pharma Sector in Switzerland ** </font>


<br>
<br>

## {.tabset}


### Continents

```{r, echo = F}

select_conti <- distinct(dat_ii, conti, geo)  %>% na.omit()

  output$conti =  DT::renderDT(select_conti, extensions = 'Scroller', server = F,
                  class = "display nowrap compact", # style
                  filter = "top", # location of column filters
                  rownames= FALSE,
                  fillContainer = T,
                  selection = list(mode = 'multiple', selected = which(select_conti$geo %in% c("Europe"))),
                  options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
         			columnDefs = list(list(className = 'dt-center', targets = 1))))

DT::dataTableOutput('conti')


selectedRow_conti <- eventReactive(input$conti_rows_selected,{
   select_conti[input$conti_rows_selected, "conti"]
  })


# renderText(selectedRow_conti())


renderPlotly({
  plot02_data_conti <- filter(dat_ii, conti %in% selectedRow_conti() & ipc_3 == "all" & abs_rel == "abs")

          # make the plot
                 ggplotly(
                 ggplot(data =   plot02_data_conti, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = FALSE) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=TRUE)) %>%
                 layout(yaxis = list(fixedrange=TRUE))
         })

        
```

```{r, echo = F}
# define the input panel for continents and IPCs: -------------------------------------------------------------------------
   pickerInput(
   inputId = "CONTI_NAME",
   label = "Choose continents",
   choices = unique(na.omit(dat_ii$conti)),
   selected = unique(na.omit(dat_ii$conti)),
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = TRUE)

pickerInput(
   inputId = "CONTI_ABS_REL",
   label = "Choose absolut or relative",
   choices = unique(na.omit(dat_ii$abs_rel)),
   selected = "abs",
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = F)

pickerInput(
   inputId = "CONTI_IPC",
   label = "Choose IPC",
   choices = unique(dat_ii$Description),
   selected = "all",
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = TRUE)

```

```{r, echo = F}
# define the output panel : -------------------------------------------------------------------------
renderPlotly({

         # subset the data according to the input:
                              plot2_data_conti <- subset(dat_ii,
                              conti %in% input$CONTI_NAME &
                              Description %in% input$CONTI_IPC &
                              abs_rel %in%  input$CONTI_ABS_REL)
     

          # make the plot
                 abs <- ggplotly(
                 ggplot(data = plot2_data_conti, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = FALSE) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=TRUE)) %>%
                 layout(yaxis = list(fixedrange=TRUE))
         })
```
<span style="font-size:0.8em">*Source: Own estimations of <a href="http://cieb.unibas.ch/" target = "_blank">CIEB</a> based on data.  All the data is available on [GitHub](https://github.com/matthnig/green-potential).*</span>

HERE short description of the findings at the continent level

### Countries

```{r, echo = F}

select_country <- distinct(dat_ii, ctry_name, geo)  %>% na.omit()

output$country <- DT::renderDT(select_country, server = F, extensions = 'Scroller',  
                  filter = "top", # location of column filters
                  rownames= FALSE,
                  class = "display nowrap compact", 
                  selection = list(mode = 'multiple', selected = which(select_country$geo %in% c("Germany", "Switzerland", "United States"))),
                  options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
         			columnDefs = list(list(className = 'dt-center', targets = 1))))


selectedRow_ctry <- eventReactive(input$country_rows_selected,{
   select_country[input$country_rows_selected, "geo"]
  })

DT::dataTableOutput('country')

# renderText(selectedRow_ctry())

## Add clearing of rows
proxy <- dataTableProxy('country')
actionButton('clear1', 'Clear Selection')
observeEvent(input$clear1, {
    proxy %>% selectRows(NULL)
  })

## Create plot
renderPlotly({
  plot02_data_country <- filter(dat_ii, ctry_name %in% selectedRow_ctry() & ipc_3 == "all" & abs_rel == "abs")

          # make the plot
                 ggplotly(
                 ggplot(data = plot02_data_country, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = FALSE) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=TRUE)) %>%
                 layout(yaxis = list(fixedrange=TRUE))
         })

        
```


```{r, echo = F}
## define the input panel for countries and IPCs: -------------------------------------------------------------------------

pickerInput(
   inputId = "CTRY_NAME",
   label = "Choose countries",
   choices = unique(na.omit(dat_ii$ctry_name)),
   selected = c("Switzerland", "Germany"),
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = TRUE)


pickerInput(
   inputId = "CTRY_ABS_REL",
   label = "Choose absolut or relative",
    choices = unique(na.omit(dat_ii$abs_rel)),
   selected = "abs",
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = F)



 pickerInput(
   inputId = "CTRY_IPC",
   label = "Choose IPC",
   choices = unique(dat_ii$ipc_3),
   selected = "all",
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = TRUE)

```

```{r, echo = F}
# define the output panel : -------------------------------------------------------------------------
renderPlotly({

                              plot2_data_ctry <- subset(dat_ii,
                              ctry_name %in% input$CTRY_NAME &
                              ipc_3 %in% input$CTRY_IPC & 
                              abs_rel %in%  input$CTRY_ABS_REL)
  
    
                              
         # make the plot
                 abs <- ggplotly(
                 ggplot(data = plot2_data_ctry, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("\nPriority Year")+
                 ylab("\n\n\nNumber of patents")+
                 guides(color = FALSE)+
                 # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = FALSE) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=TRUE)) %>%
                 layout(yaxis = list(fixedrange=TRUE))
       #  
       # if(input$CTRY_ABS_REL == "absolute"){
       #           world <- ggplotly(
       #           ggplot(data = plot2_data_ctry, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
       #           geom_point(alpha = 0.7) +
       #           geom_line() +
       #           xlab("\nPriority Year")+
       #           ylab("\nNumber of patents")+
       #           guides(color = FALSE)+
       #           facet_wrap(~ abs_rel) +
       #           # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
       #           theme(axis.title = element_text(face="bold",size = 10),
       #                 panel.background = element_blank(),
       #                 axis.line = element_line()                       ),
       #           dynamicTicks = FALSE) %>%
       #           config(displayModeBar = F) %>%
       #           layout(xaxis = list(fixedrange=TRUE)) %>%
       #           layout(yaxis = list(fixedrange=TRUE))
       #           
       #           } else {
       #             
       #           world <- ggplotly(
       #           ggplot(data = plot2_data_ctry, aes(x = p_year, y= 1/share_inv, color = geo, shape = ipc_3)) +
       #           geom_point(alpha = 0.7) +
       #           geom_line() +
       #           # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
       #           xlab("\nPriority Year")+
       #           ylab("\nNumber of patents")+
       #           guides(color = FALSE)+
       #           # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
       #           theme(axis.title = element_text(face="bold",size = 10),
       #                 panel.background = element_blank(),
       #                 axis.line = element_line()
       #                 ),
       #           dynamicTicks = FALSE) %>%
       #           config(displayModeBar = F) %>%
       #           layout(xaxis = list(fixedrange=TRUE)) %>%
       #           layout(yaxis = list(fixedrange=TRUE)) 
       #           }
       # 
       #         
       #           
       #  # subplot(abs, world, nrows = 1)
       #  
       })
```
<span style="font-size:0.8em">*Source: Own estimations of <a href="http://cieb.unibas.ch/" target = "_blank">CIEB</a> based on data.  All the data is available on [GitHub](https://github.com/matthnig/green-potential).*</span>

HERE short description of the findings at the country level


### Regions
```{r, echo = F}

select_regio <- distinct(dat_ii, Up_reg_label, geo)  %>% na.omit()

output$regio <- DT::renderDT(select_regio, server = F, extensions = 'Scroller',  
                  filter = "top", # location of column filters
                  rownames= FALSE,
                  class = "display nowrap compact", 
                  selection = list(mode = 'multiple', selected = which(select_regio$Up_reg_label %in% c("CH - Northwestern Switzerland "))),
                  options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
         			columnDefs = list(list(className = 'dt-center', targets = 1))))


selectedRow_regio <- eventReactive(input$regio_rows_selected,{
   select_regio[input$regio_rows_selected, "Up_reg_label"]
  })

DT::dataTableOutput('regio')

## Add clearing of rows
proxy <- dataTableProxy('regio')
actionButton('clear_reg', 'Clear Selection')
observeEvent(input$clear_reg, {
    proxy %>% selectRows(NULL)
  })

## Create plot
renderPlotly({
  plot02_data_regio <- filter(dat_ii, Up_reg_label %in% selectedRow_regio() & ipc_3 == "all" & abs_rel == "abs")

          # make the plot
                 ggplotly(
                 ggplot(data = plot02_data_regio, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = FALSE) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=TRUE)) %>%
                 layout(yaxis = list(fixedrange=TRUE))
         })

        
```


```{r, echo = F}
## define the input panel for regions and IPCs: -------------------------------------------------------------------------

pickerInput(
   inputId = "REGIO_NAME",
   label = "Choose regions",
   choices = unique(na.omit(dat_ii$Up_reg_label)),
   selected = c("Northwestern Switzerland", "Massachusetts"),
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = TRUE)

pickerInput(
   inputId = "REGIO_ABS_REL",
   label = "Choose absolut or relative",
   choices = unique(na.omit(dat_ii$abs_rel)),
   selected = "abs",
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = F)



 pickerInput(
   inputId = "REGIO_IPC",
   label = "Choose IPC",
   choices = unique(dat_ii$ipc_3),
   selected = "all",
   options = list(
     `actions-box` = TRUE,
     size = 10,
     `selected-text-format` = "count > 3",
     `count-selected-text` = "All",
     `deselect-all-text` = "Discard all",
     `select-all-text` = "Select all",
     `none-selected-text` = 'No country selected'),
   multiple = TRUE)

```


```{r, echo = F}
plot2_data <- reactive({plot2_data <- subset(dat_ii,
                              Up_reg_label %in% input$REGIO_NAME &
                              ipc_3 %in% input$REGIO_IPC &
                              abs_rel %in%  input$REGIO_ABS_REL)})
```


```{r, echo = F}
# define the output panel : -------------------------------------------------------------------------

renderPlotly({
         # make the plot
                 abs <- ggplotly(
                 ggplot(data = plot2_data(), aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
                 geom_point(alpha = 0.7) +
                 geom_line() +
                 # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
                 xlab("Priority Year")+
                 ylab("Number of patents")+
                 guides(color = FALSE)+
                 # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
                 theme(axis.title = element_text(face="bold",size = 10),
                       panel.background = element_blank(),
                       axis.line = element_line()
                       ),
                 dynamicTicks = FALSE) %>%
                 config(displayModeBar = F) %>%
                 layout(xaxis = list(fixedrange=TRUE)) %>%
                 layout(yaxis = list(fixedrange=TRUE))

       # if(input$REGIO_ABS_REL == "absolute"){
       #           world <- ggplotly(
       #           ggplot(data = plot2_data, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
       #           geom_point(alpha = 0.7) +
       #           geom_line() +
       #           xlab("\nPriority Year")+
       #           ylab("\nNumber of patents")+
       #           guides(color = FALSE)+
       #           facet_wrap(~ abs_rel) +
       #           # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
       #           theme(axis.title = element_text(face="bold",size = 10),
       #                 panel.background = element_blank(),
       #                 axis.line = element_line()                       ),
       #           dynamicTicks = FALSE) %>%
       #           config(displayModeBar = F) %>%
       #           layout(xaxis = list(fixedrange=TRUE)) %>%
       #           layout(yaxis = list(fixedrange=TRUE))
       # 
       #           } else {
       # 
       #           world <- ggplotly(
       #           ggplot(data = plot2_data, aes(x = p_year, y= 1/share_inv, color = geo, shape = ipc_3)) +
       #           geom_point(alpha = 0.7) +
       #           geom_line() +
       #           # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
       #           xlab("\nPriority Year")+
       #           ylab("\nNumber of patents")+
       #           guides(color = FALSE)+
       #           # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
       #           theme(axis.title = element_text(face="bold",size = 10),
       #                 panel.background = element_blank(),
       #                 axis.line = element_line()
       #                 ),
       #           dynamicTicks = FALSE) %>%
       #           config(displayModeBar = F) %>%
       #           layout(xaxis = list(fixedrange=TRUE)) %>%
       #           layout(yaxis = list(fixedrange=TRUE))
       #           }
       # 
       # 
       # 
       #  # subplot(abs, world, nrows = 1)
       # 
        })
```
<span style="font-size:0.8em">*Source: Own estimations of <a href="http://cieb.unibas.ch/" target = "_blank">CIEB</a> based on data.  All the data is available on [GitHub](https://github.com/matthnig/green-potential).*</span>

HERE short description of the findings at the regional level
```{r, echo = F}
renderTable({head(as.data.frame(plot2_data())[1:2, ])})

```

## {.unlisted .unnumbered}


