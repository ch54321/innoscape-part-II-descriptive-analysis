```{r, echo = F}

select_conti <- distinct(dat_ii, Continent, `Rank based on total patents`)  %>% na.omit()

output$conti =  DT::renderDT(select_conti, extensions = 'Scroller', server = F,
                             class = "display nowrap compact", # style
                             filter = "top", # location of column filters
                             rownames= FALSE,
                             fillContainer = T,
                             selection = list(mode = 'multiple', selected = which(select_conti$Continent %in% c("Europe"))),
                             options = list(scrollY = 180, scroller = TRUE, dom = 't', scrollX= T,
                                            columnDefs = list(list(className = 'dt-center', targets = 1))))

DT::dataTableOutput('conti')

## Add clearing of rows
proxy_conti <- dataTableProxy('conti')
actionButton('clear_conti', 'Clear Selection')
observeEvent(input$clear_conti, {
  proxy_conti %>% selectRows(NULL)
})

selectedRow_conti <- eventReactive(input$conti_rows_selected,{
  select_conti[input$conti_rows_selected, "Continent"]
})

## Add button to choose between absolut and relative value
actionButton('abs_rel_conti', "Absolute value /relative to 1990")
abs_rel_conti <- eventReactive(input$abs_rel_conti,{
  ifelse(input$abs_rel_conti %in% c(0, seq(2, 1000, 2)), "abs", "rel_1990")}, ignoreNULL = FALSE)

## Add button to choose between count each region as one (ie, 3 inventors in three regions, each region counts as one for this patent) or count the relative share of each region (ie, 3 inventors in three regions, each region counts as 1/3 for this patent) 
actionButton('geo_one_inv_conti', "Region count as share or share/one")
geo_one_inv_conti <- eventReactive(input$geo_one_inv_conti,{
  ifelse(input$geo_one_inv_conti %in% c(0, seq(2, 1000, 2)), "no", "no_yes")}, ignoreNULL = FALSE)

## Add button to choose between absolute value or share relative to overall patents for a given year
actionButton("geo_share_conti", "Absolute value / relative to all patents")
geo_share_conti <- eventReactive(input$geo_share_conti, {ifelse(input$geo_share_conti %in% c(0, seq(2, 1000, 2)), "abs", "rel")}, ignoreNULL = FALSE)

renderPlotly({
  plot02_data_conti <- filter(dat_ii, Continent %in% selectedRow_conti() & ipc_3 == "all" & abs_rel %in% abs_rel_conti() & geo_one_inv %in% geo_one_inv_conti())
  if(geo_share_conti() == "abs"){
    # make the plot
    ggplotly(
      ggplot(data =   plot02_data_conti, aes(x = p_year, y= share_inv, color = geo, shape = ipc_3)) +
        geom_point(alpha = 0.7) +
        geom_line() +
        # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
        xlab("Priority Year")+
        ylab("Number of patents")+
        guides(color = FALSE)+
        scale_x_continuous(breaks = seq(min(plot02_data_conti$p_year), max(plot02_data_conti$p_year), by = 5)) +
        # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
        theme(axis.title = element_text(face="bold",size = 10),
              panel.background = element_blank(),
              axis.line = element_line()), 
      dynamicTicks = FALSE) %>%
      config(displayModeBar = F) %>%
      layout(xaxis = list(fixedrange=F, 
                          rangeslider = list(type = "date", visible=T, thickness=0.1))) %>%
      layout(yaxis = list(fixedrange=F)) 
  } else  {
    ggplotly(
      ggplot(data =   plot02_data_conti, aes(x = p_year, y= share_geo, color = geo, shape = ipc_3)) +
        geom_point(alpha = 0.7) +
        geom_line() +
        # geom_text(aes(label = NOGA2digit), size = 4, check_overlap = FALSE, position = position_nudge(y = +0.1))+
        xlab("Priority Year")+
        ylab("Number of patents")+
        guides(color = FALSE)+
        scale_x_continuous(breaks = seq(min(plot02_data_conti$p_year), max(plot02_data_conti$p_year), by = 5)) +
        # scale_color_viridis(option="viridis", begin = 0.7, end = 0.4, discrete = FALSE, name = "None")+
        theme(axis.title = element_text(face="bold",size = 10),
              panel.background = element_blank(),
              axis.line = element_line()), 
      dynamicTicks = FALSE) %>%
      config(displayModeBar = F) %>%
      layout(xaxis = list(fixedrange=F, 
                          rangeslider = list(type = "date", visible=T, thickness=0.1))) %>%
      layout(yaxis = list(fixedrange=F)) 
  }
})


```
