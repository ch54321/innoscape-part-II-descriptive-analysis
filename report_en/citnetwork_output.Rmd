```{r, echo=FALSE}

fluidPage(
  fluidRow(
    column(6,  
# (3a) Input panel for investigated country
pickerInput(inputId = "cit_ctry",
              label = "Choose a country", 
              choices= unique(citflow_ctry_back$ctry_cited),
              selected = c("Switzerland"),
              options = list(`actions-box` = TRUE),
              multiple = FALSE)
), column(6,
# (3b) Input panels flows from and to
pickerInput(inputId = "group",
              label = "Flows from and to", 
              choices=c("All", "Americas", "Asia", "Europe", "Domestic"),
              selected = c("All"),
              options = list(`actions-box` = TRUE),
              multiple = TRUE)

)))

sliderInput(inputId = "p_year_citing", label =  "Year of citation", min=1990, max=2015, value=1990, sep="")


# (2) Create function to calculate coordinates for each unique technology that is cited in a c
# credit: https://stackoverflow.com/users/1465387/sebastian-c on
# https://stackoverflow.com/questions/40279052/coordinates-of-equally-distanced-n-points-on-a-circle-in-r
eq_spacing <- function(r = 2, data){
    # data: back or forward citations / use only subset of input picker to better distribute the technologies
    data <- data %>% filter(group %in% input$group, 
                                   ctry_cited %in% input$cit_ctry,
                                   p_year_citing %in% input$p_year_citing)
    if(nrow(data) == 0){
       data <- data %>% filter(group %in% "Domestic", 
                                   ctry_cited %in% input$cit_ctry,
                                   p_year_citing %in% 2000, 
                               tech_field_cited == 16,
                               tech_field_citing == 16)
    } else {
    coord <- sort(unique(data$tech_field_cited))
    coord <- data.frame(coord)
   
   # create unique coordinate 
    polypoints <- seq(0, 2*pi, length.out=nrow(coord)+1)
    polypoints <- polypoints[-length(polypoints)]
    circx <- r * sin(polypoints)
    circy <- r * cos(polypoints)
    numbers <- data.frame(x=circx, y=circy)
    
    coord <- cbind(coord, numbers)
    coord <- mutate(coord, coord = as.character(coord))
    coord <- mutate(coord, x = ifelse(coord == 16, 0, x), y = ifelse(coord == 16, 0, y))
    colnames(coord) <- c("tech_field_cited", "x", "y")
  
    citflow_ctry <- merge(data, coord)
  return(citflow_ctry)
    }
}


fluidPage(
  fluidRow(
    column(12,
# (4) make the first plot

renderVisNetwork({
  
# Create coordinates for backward citations
nodes <- eq_spacing(r = 0.7, data = citflow_ctry_back) 
edges <- nodes


    
# (b) Creating NODES from the reactive (filtered) data
  nodes <- dplyr::select(nodes, tech_field_cited, tech_name, group, x, y, share_inv_cited)
  colnames(nodes) <- c("id", "label", "group", "x", "y", "value_nodes")

  nodes <- mutate(nodes, label = case_when(label == "Pharmaceuticals" ~ paste0(input$cit_ctry),
                                           label == "Cited Pharmaceuticals" ~ "Pharmaceuticals",
                                           T ~ label))
    

    nodes %>% group_by(id, label, x, y, value_nodes) %>%
    summarize(group = paste(sort(unique(group)),collapse=", ")) %>%
    ungroup()  -> nodes
    
  mutate(nodes, x = case_when(
        label == paste0(input$cit_ctry, " Pharmaceuticals") ~ 0, 
        TRUE   ~ x )) -> nodes


  mutate(nodes, y = case_when(
        label == paste0(input$cit_ctry, " Pharmaceuticals") ~ 0, 
        TRUE   ~ y )) -> nodes
      
      
# (c) Creating EDGES from the reactive (filtered) data    
  edges <- subset(edges, select = c("tech_field_citing", "tech_field_cited" ,"share_inv_cited", "group"))
  colnames(edges) <- c("from", "to", "value", "group")
  edges <- filter(edges, value != 0)
    edges$title <- paste0(round(edges$value*100, 1), c(" %"))

# (d) keep only observations above a min threshold
  edges <- filter(edges, value >= 0.01)
  nodes <- filter(nodes, id %in% edges$to | id == 16)
  
# (e) Define different colors for different regions
  nodes <- mutate(nodes, value = ifelse(x == 0 & y == 0, 1, value_nodes), color = case_when(group == "All" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[1],
                                                                                            group == "Europe" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[2],
                                                                                            group == "Americas" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[4], 
                                                                                            group == "Asia" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[7],
                                                                                            group == "Domestic" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[8]),
                  group = ifelse(group %in% c("All", "Europe", "Asia", "Americas", "Domestic"), group, NA))
  
# (f) create data frame for legend 
 nodes_temp <- filter(nodes, is.na(group) != T)
 ledges <- data.frame(color = unique(nodes_temp$color), 
 label = unique(nodes_temp$group), shape = rep("dot", length(unique(nodes_temp$group)))) 
 
# (g) Creating Network Plot
  visNetwork(nodes, edges, height = "100%",  width = "100%", main = paste("Knowledge flows from other technologies to pharma")) %>%
      visIgraphLayout(layout = "layout_nicely") %>%
      visEvents(type = "once", startStabilizing = "function() {
               this.moveTo({scale:0.5})}") %>%
      visPhysics(stabilization = FALSE) %>%
      visNodes(
        fixed = TRUE,
        shape = "dot",
        color=colorRampPalette(brewer.pal(8, "RdBu"))(8)[6],
        shadow = list(enabled = F, size = 20)
        ) %>%
    visEdges(
        value="value",
        scaling = list(min = min(unique(edges$value), rm.na = T)*8, max = max(unique(edges$value), rm.na = T)*8),
        arrows = "from",
        color="lightgrey",
        selfReferenceSize = F,
        shadow = FALSE,
        smooth = FALSE) %>%
    visInteraction(dragNodes = F, dragView = F, zoomView = T)%>%
    visOptions(highlightNearest = list(enabled = F, degree = 1, hover = T))%>%
    visLegend(position = "right", width = 0.4, stepX = 50, stepY = 100, ncol = 1,  useGroups = F, addNodes = ledges, zoom = F) 
  })    
)),
  fluidRow(column(12,
# make the 2nd plot
renderVisNetwork({
  
# Create coordinates for forward citations used in 2nd plot
 nodes_2 <- eq_spacing(r = 0.5, data = citflow_ctry_forw) 
 edges_2 <- nodes_2
    
# (b) Creating NODES from the reactive (filtered) data
  nodes_2 <- dplyr::select(nodes_2, tech_field_cited, tech_name, group, x, y, share_inv_cited)
  colnames(nodes_2) <- c("id", "label", "group", "x", "y", "value_nodes")
  nodes_2 <- mutate(nodes_2, label = case_when(label == "Pharmaceuticals" ~ paste0(input$cit_ctry),
                                           label == "Cited Pharmaceuticals" ~ "Pharmaceuticals",
                                           T ~ label))
  
 nodes_2 %>% group_by(id, label, x, y, value_nodes) %>%
   summarize(group = paste(sort(unique(group)),collapse=", ")) %>%
   ungroup()  -> nodes_2

  mutate(nodes_2, x = case_when(
        label == paste0(input$cit_ctry, " Pharmaceuticals") ~ 0, 
        TRUE   ~ x )) -> nodes_2

  mutate(nodes_2, y = case_when(
        label == paste0(input$cit_ctry, " Pharmaceuticals") ~ 0, 
        TRUE   ~ y )) -> nodes_2
      
      
# (c) Creating EDGES from the reactive (filtered) data    
  edges_2 <- subset(edges_2, select = c("tech_field_citing", "tech_field_cited" ,"share_inv_cited", "group"))
  colnames(edges_2) <- c("from", "to", "value", "group")
  edges_2 <- filter(edges_2, value != 0)
  edges_2$title <- paste0(round(edges_2$value*100, 1), c(" %"))
  
# (d) keep only observations above a min threshold
  edges_2 <- filter(edges_2, value >= 0.01)
  nodes_2 <- filter(nodes_2, id %in% edges_2$to | id == 16)
  
# (e) Define different colors for different regions
  nodes_2 <- mutate(nodes_2, value = ifelse(x == 0 & y == 0, 1, value_nodes), color = case_when(group == "All" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[1],
                                                                                            group == "Europe" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[2],
                                                                                            group == "Americas" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[4], 
                                                                                            group == "Asia" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[7],
                                                                                            group == "Domestic" ~ colorRampPalette(brewer.pal(8, "RdBu"))(8)[8]),
                  group = ifelse(group %in% c("All", "Europe", "Asia", "Americas", "Domestic"), group, NA))
  
# (f) create data frame for legend 
 nodes_2_temp <- filter(nodes_2, is.na(group) != T)
 ledges_2 <- data.frame(color = unique(nodes_2_temp$color),
 label_2 = unique(nodes_2_temp$group), shape = rep("dot", length(unique(nodes_2_temp$group))))
 
# (g) Creating Network Plot
  visNetwork(nodes_2, edges_2, height = "100%",  width = "100%", main = paste("Knowledge flows from pharma to other technologies")) %>%
      visIgraphLayout(layout = "layout_nicely") %>%
      visEvents(type = "once", startStabilizing = "function() {
               this.moveTo({scale:0.5})}") %>%
      visPhysics(stabilization = FALSE) %>%
      visNodes(
        fixed = TRUE,
        shape = "dot",
       color=colorRampPalette(brewer.pal(8, "RdBu"))(8)[6],
        shadow = list(enabled = F, size = 20)
        ) %>%
    visEdges(
        value="value",
        scaling = list(min = min(unique(edges_2$value), rm.na = T)*8, max = max(unique(edges_2$value), rm.na = T)*8),
        arrows = "to",
        color="lightgrey",
        selfReferenceSize = F,
        shadow = FALSE,
        smooth = FALSE) %>%
    visInteraction(dragNodes = F, dragView = F, zoomView = T)%>%
    visOptions(highlightNearest = list(enabled = F, degree = 1, hover = T)) 
  
}) 
)))
```

